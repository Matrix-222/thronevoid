<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="MATCHING_PROFILES">ملفات التعارف</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .main-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        #profiles-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID - CHAT</h1>
        <div class="header-buttons">
            <button onclick="window.location='dashboard.html'" data-i18n="PROFILE" style="background-color: var(--accent-blue);">ملفي الشخصي</button>
            <button onclick="logoutUser()" class="logout-btn" data-i18n="LOGOUT">تسجيل الخروج</button>
        </div>
    </header>

    <main class="main-container">
        <h2 data-i18n="FIND_NEW_PEOPLE" style="color: var(--accent-green);">ابحث عن أشخاص جدد</h2>
        <input type="text" id="searchBar" data-i18n="SEARCH_PROFILES_PLACEHOLDER" placeholder="ابحث بالاسم أو الاهتمامات...">

        <div id="profiles-list">
            </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** مفاتيح مشروعك الفعلي (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const profilesList = document.getElementById('profiles-list');
        const searchBar = document.getElementById('searchBar');
        let currentUserEmail = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                fetchProfiles();
            } else {
                window.location.href = "index.html";
            }
        });

        async function fetchProfiles(searchTerm = '') {
            profilesList.innerHTML = `<p style="text-align: center; color: var(--text-muted);">جار التحميل...</p>`;
            
            const usersRef = collection(db, "users");
            // جلب جميع المستخدمين
            const q = query(usersRef); 

            try {
                const snapshot = await getDocs(q);
                profilesList.innerHTML = '';
                let foundProfiles = 0;

                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const profileEmail = doc.id;
                    
                    // استثناء المستخدم الحالي
                    if (profileEmail === currentUserEmail) return;

                    const username = userData.username || profileEmail.split('@')[0];
                    const interests = userData.interests || loadLanguage('DEFAULT_INTERESTS');
                    const bio = userData.bio || loadLanguage('DEFAULT_BIO');

                    // تصفية بسيطة بناءً على الاسم أو الاهتمامات
                    const searchLower = searchTerm.toLowerCase();
                    if (searchTerm === '' || 
                        username.toLowerCase().includes(searchLower) ||
                        interests.toLowerCase().includes(searchLower) ||
                        bio.toLowerCase().includes(searchLower)) 
                    {
                        profilesList.appendChild(createProfileCard(username, interests, profileEmail));
                        foundProfiles++;
                    }
                });
                
                if (foundProfiles === 0) {
                    profilesList.innerHTML = `<p style="text-align: center; color: var(--text-muted);" data-i18n="NO_PROFILES_FOUND">${loadLanguage('NO_PROFILES_FOUND')}</p>`;
                }

            } catch (error) {
                console.error("Error fetching profiles:", error);
                profilesList.innerHTML = `<p style="text-align: center; color: #e74c3c;">فشل تحميل الملفات.</p>`;
            }
            
        }
        
        searchBar.addEventListener('input', (e) => {
            fetchProfiles(e.target.value.trim());
        });

        function createProfileCard(username, interests, email) {
            const card = document.createElement('div');
            card.className = 'profile-card';
            card.innerHTML = `
                <img src="https://i.pravatar.cc/150?u=${email}" alt="Avatar">
                <h3>${username}</h3>
                <p>الاهتمامات: ${interests}</p>
                <button class="start-chat-btn" data-email="${email}" style="background-color: var(--accent-green);" data-i18n="START_CHAT">ابدأ الدردشة</button>
            `;
            
            card.querySelector('.start-chat-btn').addEventListener('click', (e) => {
                const targetEmail = e.target.getAttribute('data-email');
                // التوجيه إلى صفحة المحادثة مع تحديد المستخدم المستهدف
                window.location.href = `private_chat.html?user=${targetEmail}`;
            });

            return card;
        }
        
        window.logoutUser = function() {
            signOut(auth).then(() => { 
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        }
    </script>
</body>
</html>
