<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="MATCHING_PROFILES">Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¹Ø§Ø±Ù</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ØªØ®Ø·ÙŠØ· Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .main-container {
            max-width: 1300px;
            margin: 40px auto;
            padding: 0 20px;
            display: flex; 
            gap: 30px;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„ØªØµÙÙŠØ© */
        .sidebar {
            width: 280px;
            background-color: var(--secondary-dark);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            height: fit-content;
        }
        .sidebar h3 {
            color: var(--accent-blue);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .filter-group {
            margin-bottom: 20px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: bold;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª */
        .profiles-content {
            flex-grow: 1;
        }
        #profiles-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Profile Card) */
        .profile-card {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border-bottom: 5px solid var(--accent-green);
        }
        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6);
        }
        .profile-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .profile-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-blue);
        }
        .profile-card h3 {
            color: var(--text-light);
            margin: 10px 0 5px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .profile-card .interests-tag {
            background-color: #333;
            color: var(--accent-green);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* ğŸ’¡ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .online-dot {
            height: 10px;
            width: 10px;
            background-color: var(--accent-green);
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 2px;
        }

        /* Ø§Ù„Ù€ Media Queries Ù„Ù„ØªØ¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
                padding: 0 10px;
            }
            .sidebar {
                width: 100%; 
                margin-bottom: 20px;
            }
            #profiles-list {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID - CHAT</h1>
        <div class="header-buttons">
            <button onclick="window.location='dashboard.html'" data-i18n="PROFILE" style="background-color: var(--accent-blue);">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</button>
            <button onclick="logoutUser()" class="logout-btn" data-i18n="LOGOUT">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <main class="main-container">
        <div class="sidebar">
            <h3 data-i18n="ADVANCED_FILTERS">ØªØµÙÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
            
            <div class="filter-group">
                <label for="filterInterests">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</label>
                <input type="text" id="filterInterests" placeholder="Ù…Ø«Ù„: Ù‚Ø±Ø§Ø¡Ø©, Ø³ÙØ±">
            </div>

            <div class="filter-group" style="display: flex; align-items: center;">
                <label for="filterOnline" style="margin-bottom: 0; flex-grow: 1;">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙÙ‚Ø·</label>
                <input type="checkbox" id="filterOnline">
            </div>

            <button id="applyFiltersBtn" style="width: 100%; background-color: var(--accent-green);">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©</button>
        </div>

        <div class="profiles-content">
            <h2 data-i18n="FIND_NEW_PEOPLE" style="color: var(--accent-green);">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø´Ø®Ø§Øµ Ø¬Ø¯Ø¯</h2>
            
            <input type="text" id="searchBar" data-i18n="SEARCH_PROFILES_PLACEHOLDER" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù†Ø¨Ø°Ø©..." style="margin-bottom: 20px;">

            <div id="profiles-list">
                </div>
        </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            getDocs,
            doc, // Ø¬Ø¯ÙŠØ¯: Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
            updateDoc, // Ø¬Ø¯ÙŠØ¯: Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            serverTimestamp // Ø¬Ø¯ÙŠØ¯: Ù„ØªØ³Ø¬ÙŠÙ„ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (thronevoid) - ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§ ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = null;
        let allProfiles = [];

        const profilesList = document.getElementById('profiles-list');
        const searchBar = document.getElementById('searchBar');
        const filterInterests = document.getElementById('filterInterests');
        const filterOnline = document.getElementById('filterOnline');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');

        // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Firestore
        async function setUserOnlineStatus(isOnline) {
            if (!currentUserEmail) return;
            try {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                await updateDoc(doc(db, "users", currentUserEmail), {
                    isOnline: isOnline,
                    lastSeen: isOnline ? null : serverTimestamp()
                });
            } catch (error) {
                console.error("Failed to update user status:", error);
            }
        }
        
        // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                setUserOnlineStatus(true); // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù…ØªØµÙ„" Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…ØªØµÙ„" Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
                window.addEventListener('beforeunload', () => setUserOnlineStatus(false));
                
                fetchAllProfiles();
            } else {
                window.location.href = "index.html";
            }
        });

        async function fetchAllProfiles() {
            profilesList.innerHTML = `<p style="text-align: center; color: var(--text-muted);">Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª...</p>`;
            
            const usersRef = collection(db, "users");
            const snapshot = await getDocs(query(usersRef)); 
            
            allProfiles = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                const profileEmail = doc.id;
                
                if (profileEmail !== currentUserEmail) {
                    allProfiles.push({ id: profileEmail, ...data });
                }
            });
            
            applyFilters(); 
        }

        // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„ØªØ¶Ù…ÙŠÙ† Ø´Ø±Ø· "Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙÙ‚Ø·"
        function applyFilters() {
            const searchTerm = searchBar.value.trim().toLowerCase();
            const interestFilter = filterInterests.value.trim().toLowerCase().split(',').map(i => i.trim()).filter(i => i);
            const showOnlineOnly = filterOnline.checked; // Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            
            let filteredProfiles = allProfiles.filter(profile => {
                const username = (profile.username || profile.id.split('@')[0]).toLowerCase();
                const bio = (profile.bio || '').toLowerCase();
                const interests = (profile.interests || '').toLowerCase();
                const isOnline = profile.isOnline === true; // Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù

                // 1. ØªØµÙÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù†Ø¨Ø°Ø©
                const matchesSearch = searchTerm === '' || 
                                      username.includes(searchTerm) ||
                                      bio.includes(searchTerm);
                
                if (!matchesSearch) return false;

                // 2. ØªØµÙÙŠØ© Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª
                const matchesInterests = interestFilter.length === 0 || 
                                         interestFilter.every(tag => interests.includes(tag));
                
                if (!matchesInterests) return false;
                
                // 3. ØªØµÙÙŠØ© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙÙ‚Ø· (Ø¬Ø¯ÙŠØ¯)
                const matchesOnline = !showOnlineOnly || isOnline; 

                return matchesOnline;
            });

            renderProfiles(filteredProfiles);
        }

        function renderProfiles(profiles) {
            profilesList.innerHTML = '';
            if (profiles.length === 0) {
                profilesList.innerHTML = `<p style="text-align: center; color: var(--text-muted);" data-i18n="NO_PROFILES_FOUND">${loadLanguage('NO_PROFILES_FOUND')}</p>`;
                return;
            }

            profiles.forEach(profile => {
                profilesList.appendChild(createProfileCard(profile));
            });
        }
        
        // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ù Ù„Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function createProfileCard(profile) {
            const card = document.createElement('div');
            card.className = 'profile-card';
            
            const username = profile.username || profile.id.split('@')[0];
            const interestsList = (profile.interests || '').split(',').map(i => i.trim()).filter(i => i).slice(0, 3);
            const targetEmail = profile.id; 
            const isOnline = profile.isOnline === true; // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„Ø©

            card.innerHTML = `
                <div class="profile-card-header">
                    <img src="https://i.pravatar.cc/150?u=${profile.id}" alt="Avatar">
                    <h3>
                        ${username} 
                        ${isOnline ? '<span class="online-dot" title="Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†"></span>' : ''}
                    </h3>
                </div>
                <p style="color: var(--text-muted); font-style: italic;">${profile.bio || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©.'}</p>
                <p style="margin-top: 10px;">
                    ${interestsList.map(i => `<span class="interests-tag">${i}</span>`).join(' ')}
                </p>
                <button onclick="redirectToChat(this)"
                        data-email="${targetEmail}" 
                        style="background-color: var(--accent-green); margin-top: 15px;" 
                        data-i18n="START_CHAT">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
            `;
            
            if (window.loadLanguage) { 
                const button = card.querySelector('.start-chat-btn');
                if (button) button.textContent = loadLanguage('START_CHAT');
            }
            return card;
        }
        
        // ğŸ’¡ Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„Ø¨Ø­Ø« Ø¨Ø¯Ø§Ù„Ø© applyFilters
        searchBar.addEventListener('input', applyFilters);
        filterInterests.addEventListener('input', applyFilters); // Ø§Ù„ØªØµÙÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª
        filterOnline.addEventListener('change', applyFilters); // Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        applyFiltersBtn.addEventListener('click', applyFilters); // Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        
        window.logoutUser = function() {
            // ğŸ’¡ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…ØªØµÙ„" Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            setUserOnlineStatus(false).finally(() => {
                signOut(auth).then(() => { 
                    window.location.href = "index.html";
                }).catch((error) => {
                    console.error("Logout Error:", error);
                });
            });
        }
    </script>
    
    <script>
        function redirectToChat(buttonElement) {
            const emailToChatWith = buttonElement.getAttribute('data-email');
            
            if (emailToChatWith) {
                console.log(`âœ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¬Ø¨Ø±ÙŠ Ø¥Ù„Ù‰: private_chat.html?user=${emailToChatWith}`);
                window.location.href = `private_chat.html?user=${emailToChatWith}`;
            } else {
                console.error("âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù‡Ø¯Ù Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ Ø®Ø§ØµÙŠØ© data-email.");
            }
        }
    </script>
</body>
</html>
