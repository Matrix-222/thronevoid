<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="MATCHING_PROFILES">ملفات التعارف</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS خاص لواجهة التعارف */
        .main-container {
            max-width: 900px;
            margin: 40px auto;
            background-color: var(--secondary-dark);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            min-height: 70vh;
        }
        #profiles-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .profile-card {
            background-color: #333;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border-top: 4px solid var(--accent-yellow);
        }
        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
        }
        .profile-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--accent-blue);
        }
        .profile-card h3 {
            color: var(--accent-yellow);
            margin: 5px 0;
        }
        .profile-card p {
            color: #ccc;
            font-size: 0.9em;
        }
        .start-chat-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID - CHAT</h1>
        <div>
            <button onclick="logoutUser()" style="background-color: #e74c3c;" data-i18n="LOGOUT">تسجيل الخروج</button>
        </div>
    </header>

    <main class="main-container">
        <h2 data-i18n="FIND_NEW_PEOPLE">ابحث عن أشخاص جدد</h2>
        <input type="text" id="searchBar" data-i18n="SEARCH_PROFILES_PLACEHOLDER" placeholder="ابحث بالاسم أو الاهتمامات..." style="width: 100%; padding: 10px; border-radius: 8px;">

        <div id="profiles-list">
            </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        // ... (كود Firebase الأساسي)

        // سنركز على وظيفة جلب وعرض الملفات
        
        const db = getFirestore(app);
        const auth = getAuth(app);
        const profilesList = document.getElementById('profiles-list');
        const searchBar = document.getElementById('searchBar');
        let currentUserEmail = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                fetchProfiles();
            } else {
                window.location.href = "index.html";
            }
        });

        async function fetchProfiles(searchTerm = '') {
            profilesList.innerHTML = '<p>جار التحميل...</p>';
            
            // جلب كل المستخدمين باستثناء المستخدم الحالي
            const usersRef = collection(db, "users");
            const q = query(usersRef, where('email', '!=', currentUserEmail));

            const snapshot = await getDocs(q);
            profilesList.innerHTML = '';

            snapshot.forEach(doc => {
                const userData = doc.data();
                const username = userData.username || doc.id.split('@')[0];
                const interests = userData.interests || 'لا توجد اهتمامات محددة';
                const profileId = doc.id;

                // تصفية بسيطة بناءً على الاسم أو الاهتمامات
                if (searchTerm === '' || 
                    username.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    interests.toLowerCase().includes(searchTerm.toLowerCase())) 
                {
                    profilesList.appendChild(createProfileCard(username, interests, profileId));
                }
            });
            if (profilesList.innerHTML === '') {
                profilesList.innerHTML = '<p data-i18n="NO_PROFILES_FOUND">لم يتم العثور على ملفات مطابقة.</p>';
                if (window.loadLanguage) window.loadLanguage();
            }
        }
        
        searchBar.addEventListener('input', (e) => {
            fetchProfiles(e.target.value.trim());
        });

        function createProfileCard(username, interests, email) {
            const card = document.createElement('div');
            card.className = 'profile-card';
            card.innerHTML = `
                <img src="default_avatar.png" alt="Avatar">
                <h3>${username}</h3>
                <p>${interests}</p>
                <button class="start-chat-btn" data-email="${email}" data-i18n="START_CHAT">ابدأ الدردشة</button>
            `;
            
            // إضافة مستمع لبدء الدردشة الخاصة
            card.querySelector('.start-chat-btn').addEventListener('click', (e) => {
                const targetEmail = e.target.getAttribute('data-email');
                // توجيه إلى صفحة المحادثة مع تحديد المستخدم المستهدف
                window.location.href = `private_chat.html?user=${targetEmail}`;
            });

            if (window.loadLanguage) window.loadLanguage(); // لتطبيق الترجمة على زر الدردشة
            return card;
        }

        // ... (بقية كود Firebase مثل onAuthStateChanged و logoutUser)
        // يجب أن يتم إضافة كود Firebase الأساسي الذي استخدمناه في chat.html هنا.
    </script>
</body>
</html>
