<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        .user-card .avatar {
            font-size: 1.5em;
        }

    </style>
</head>
<body>
    <header>
        <div id="usernameDisplay"></div>
        <h1>THRONES OF THE VOID</h1>
        <div class="header-buttons">
            <button onclick="window.location='dashboard.html'" data-i18n="DASHBOARD_BUTTON">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button id="logoutBtn" class="logout-btn" data-i18n="LOGOUT_BUTTON">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <main>
        <div class="filters-container">
            <h2 data-i18n="ADVANCED_FILTERS">Ù…Ø±Ø´Ø­Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
            <div class="filter-group">
                <label for="genderFilter" data-i18n="GENDER_FILTER">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³:</label>
                <select id="genderFilter">
                    <option value="" data-i18n="ALL">Ø§Ù„ÙƒÙ„</option>
                    <option value="male" data-i18n="MALE">Ø°ÙƒØ±</option>
                    <option value="female" data-i18n="FEMALE">Ø£Ù†Ø«Ù‰</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchFilter" data-i18n="SEARCH_FILTER">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</label>
                <input type="text" id="searchFilter" placeholder="Ø§Ù„Ø¨Ø­Ø«...">
            </div>
            <button id="applyFiltersBtn" data-i18n="APPLY_FILTERS">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª</button>
        </div>

        <div id="userList" class="user-list">
            <p id="loadingText" style="text-align: center;">... ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ...</p>
        </div>
    </main>

    <script src="i18n.js"></script>
    <script src="api.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (thronevoid) - ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§ ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const userListContainer = document.getElementById('userList');
        let currentUserEmail = null;
        let allUsers = [];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                displayCurrentUserName(user.email);
                listenForUsers();
            } else {
                window.location.href = "index.html";
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Logout failed:", error);
            });
        });

        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);

        function displayCurrentUserName(email) {
            const usernameDisplay = document.getElementById('usernameDisplay');
            usernameDisplay.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${email.split('@')[0]}`;
        }
        
        // --- Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
        function listenForUsers() {
            const usersRef = collection(db, "users");
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… onSnapshot Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
            onSnapshot(usersRef, (snapshot) => {
                allUsers = [];
                snapshot.forEach((doc) => {
                    const user = doc.data();
                    const email = doc.id; 

                    if (email !== currentUserEmail) {
                        allUsers.push({ email, ...user });
                    }
                });
                applyFilters(); // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            }, (error) => {
                console.error("Error fetching users:", error);
                document.getElementById('loadingText').textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.';
            });
        }

        function applyFilters() {
            const genderFilter = document.getElementById('genderFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            userListContainer.innerHTML = '';
            let filteredUsers = allUsers;

            if (genderFilter) {
                filteredUsers = filteredUsers.filter(user => user.gender === genderFilter);
            }

            if (searchFilter) {
                filteredUsers = filteredUsers.filter(user => 
                    (user.username && user.username.toLowerCase().includes(searchFilter)) ||
                    (user.email && user.email.toLowerCase().includes(searchFilter))
                );
            }
            
            if (filteredUsers.length === 0) {
                 userListContainer.innerHTML = '<p style="text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø·Ø§Ø¨Ù‚ÙˆÙ† Ù„Ù„Ù…Ø±Ø´Ø­Ø§Øª.</p>';
                 return;
            }

            filteredUsers.forEach(displayUserCard);
        }

        // --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙ… Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„) ---
        function displayUserCard(user) {
            const email = user.email;
            const username = user.username || email.split('@')[0];
            
            const card = document.createElement('div');
            card.className = 'user-card';
            card.setAttribute('data-user-email', email);
            
            const gender = user.gender || 'male'; 
            
            // --- ADD AVATAR ---
            const avatar = document.createElement('div');
            avatar.className = `avatar ${gender}`;
            avatar.textContent = gender === 'male' ? 'M' : 'F'; 
            card.appendChild(avatar);
            
            // --- USER INFO CONTAINER ---
            const infoContainer = document.createElement('div');
            infoContainer.style.flexGrow = 1;

            const nameElement = document.createElement('h3');
            nameElement.innerHTML = `<span class="online-dot"></span>${username}`;
            infoContainer.appendChild(nameElement);

            /* ğŸ›‘ ØªÙ… Ø­Ø°Ù Ø³Ø·Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ:
            const emailElement = document.createElement('p');
            emailElement.textContent = email;
            emailElement.style.color = 'var(--text-muted)';
            infoContainer.appendChild(emailElement);
            */

            card.appendChild(infoContainer);
            
            card.addEventListener('click', () => {
                window.location.href = `private_chat.html?user=${email}`;
            });

            userListContainer.appendChild(card);
        }

    </script>
</body>
</html>
