<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="LOGIN">تسجيل الدخول</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .auth-container {
            max-width: 400px;
            margin: 80px auto;
            padding: 30px;
            background-color: var(--secondary-dark);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.4);
            text-align: center;
        }
        .auth-container h2 {
            color: var(--accent-yellow);
            margin-bottom: 25px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
        }
        .auth-actions button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        #authButton {
            background-color: var(--accent-blue);
            color: white;
        }
        #authButton:hover {
            background-color: #2980b9;
        }
        .social-login button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        #googleLoginBtn {
            background-color: #dd4b39; /* Google Red */
            color: white;
        }
        #googleLoginBtn:hover {
            opacity: 0.9;
        }
        #facebookLoginBtn {
            background-color: #3b5998; /* Facebook Blue */
            color: white;
        }
        #facebookLoginBtn:hover {
            opacity: 0.9;
        }

        .toggle-mode {
            margin-top: 20px;
        }
        .toggle-mode a {
            color: var(--accent-yellow);
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <button onclick="window.location='index.html'" style="background-color: #2ecc71;" data-i18n="HOME">الرئيسية</button>
        </div>
    </header>

    <main>
        <div class="auth-container">
            <h2 id="formTitle" data-i18n="LOG_IN_ACCOUNT">تسجيل الدخول / إنشاء حساب</h2>
            
            <div class="input-group" id="usernameGroup" style="display: none;">
                <input type="text" id="usernameInput" data-i18n="USERNAME_PLACEHOLDER" placeholder="اسم المستخدم" required minlength="3" maxlength="15">
            </div>
            
            <div class="input-group">
                <input type="email" id="emailInput" data-i18n="EMAIL_PLACEHOLDER" placeholder="البريد الإلكتروني" required>
            </div>
            
            <div class="input-group">
                <input type="password" id="passwordInput" data-i18n="PASSWORD_PLACEHOLDER" placeholder="كلمة المرور" required minlength="6">
            </div>
            
            <div class="input-group" id="confirmPasswordGroup" style="display: none;">
                <input type="password" id="confirmPasswordInput" data-i18n="CONFIRM_PASSWORD_PLACEHOLDER" placeholder="تأكيد كلمة المرور" required minlength="6">
            </div>

            <div class="auth-actions">
                <button id="authButton" data-i18n="AUTH_BUTTON_LOGIN">تسجيل الدخول</button>
                <div class="forgot-password" style="margin-top: 10px; text-align: right;">
                    <a href="#" data-i18n="FORGOT_PASSWORD">نسيت كلمة المرور؟</a>
                </div>
            </div>

            <hr style="margin: 25px 0; border-color: #555;">

            <div class="social-login">
                <button id="googleLoginBtn" data-i18n="SIGN_IN_WITH_GOOGLE">تسجيل الدخول باستخدام جوجل</button>
                <button id="facebookLoginBtn" data-i18n="SIGN_IN_WITH_FACEBOOK" style="background-color: #1877f2; color: white;">تسجيل الدخول باستخدام فيسبوك</button>
            </div>
            
            <div class="toggle-mode">
                <a id="toggleModeLink" onclick="toggleMode()" data-i18n="TOGGLE_TO_REGISTER">لا تملك حساباً؟ انقر للتسجيل</a>
            </div>
        </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            GoogleAuthProvider, 
            FacebookAuthProvider,
            signInWithPopup,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** مفاتيح مشروعك الفعلي (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const facebookProvider = new FacebookAuthProvider();

        let isRegisterMode = false;

        // التحقق من حالة الدخول
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // إذا كان المستخدم مسجلاً دخوله، انتقل مباشرة إلى لوحة التحكم
                window.location.href = "dashboard.html";
            }
        });

        // -------------------------------------------------------------
        //                 دالة تبديل وضع التسجيل/الدخول
        // -------------------------------------------------------------
        window.toggleMode = function() {
            isRegisterMode = !isRegisterMode;
            const formTitle = document.getElementById('formTitle');
            const authButton = document.getElementById('authButton');
            const toggleLink = document.getElementById('toggleModeLink');
            const usernameGroup = document.getElementById('usernameGroup');
            const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');

            if (isRegisterMode) {
                formTitle.setAttribute('data-i18n', 'REGISTER_ACCOUNT');
                authButton.setAttribute('data-i18n', 'AUTH_BUTTON_REGISTER');
                toggleLink.setAttribute('data-i18n', 'TOGGLE_TO_LOGIN');
                usernameGroup.style.display = 'block';
                confirmPasswordGroup.style.display = 'block';
            } else {
                formTitle.setAttribute('data-i18n', 'LOG_IN_ACCOUNT');
                authButton.setAttribute('data-i18n', 'AUTH_BUTTON_LOGIN');
                toggleLink.setAttribute('data-i18n', 'TOGGLE_TO_REGISTER');
                usernameGroup.style.display = 'none';
                confirmPasswordGroup.style.display = 'none';
            }
            // إعادة تطبيق الترجمة بعد تغيير المفاتيح
            loadLanguage();
        }

        // -------------------------------------------------------------
        //             دالة حفظ بيانات المستخدم في Firestore
        // -------------------------------------------------------------
        async function saveUserData(user, username, email) {
            // استخدام البريد الإلكتروني كمعرف المستند (Document ID)
            const documentId = email || user.uid; 
            
            // تحديد اسم المستخدم النهائي (يأتي من الإدخال اليدوي أو من Google)
            const finalUsername = username || user.displayName || "User_" + user.uid.substring(0, 5);

            const userDocRef = doc(db, "users", documentId);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) {
                 await setDoc(userDocRef, {
                    uid: user.uid,
                    email: user.email || null, 
                    username: finalUsername,
                    createdAt: new Date(),
                    allianceId: null, 
                    score: 0
                });
            }
        }

        // -------------------------------------------------------------
        //             دالة التعامل مع التسجيل/الدخول اليدوي
        // -------------------------------------------------------------
        async function handleAuth() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const username = document.getElementById('usernameInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;

            if (!email || !password) {
                alert("يرجى إدخال البريد الإلكتروني وكلمة المرور.");
                return;
            }

            try {
                if (isRegisterMode) {
                    if (password !== confirmPassword) {
                        alert("كلمة المرور وتأكيدها غير متطابقين.");
                        return;
                    }
                    if (!username || username.length < 3) {
                         alert("اسم المستخدم مطلوب ويجب أن يكون 3 أحرف على الأقل.");
                         return;
                    }

                    // 1. إنشاء المستخدم باستخدام الإيميل وكلمة المرور
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // 2. حفظ بيانات المستخدم في Firestore (لتضمين اسم المستخدم)
                    await saveUserData(userCredential.user, username, email);
                    
                    alert("✅ تم التسجيل بنجاح! سيتم توجيهك إلى لوحة التحكم.");
                    window.location.href = "dashboard.html";

                } else {
                    // وضع تسجيل الدخول
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    alert("✅ تم تسجيل الدخول بنجاح! سيتم توجيهك.");
                    window.location.href = "dashboard.html";
                }
            } catch (error) {
                let message = "فشل عملية الدخول/التسجيل: خطأ غير معروف.";
                if (error.code === 'auth/email-already-in-use') {
                    message = "البريد الإلكتروني مُسجل بالفعل.";
                } else if (error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    message = "خطأ في البريد الإلكتروني أو كلمة المرور.";
                } else if (error.code === 'auth/weak-password') {
                    message = "كلمة المرور ضعيفة جداً، يجب أن تكون 6 أحرف على الأقل.";
                }
                console.error("Authentication Error:", error);
                alert(`❌ ${message}`);
            }
        }

        // -------------------------------------------------------------
        //             دالة التسجيل/الدخول عبر موفري الهوية (Google/Facebook)
        // -------------------------------------------------------------
        async function signInWithProvider(provider) {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const email = user.email;
                const username = user.displayName;

                // حفظ بيانات المستخدم في Firestore.
                await saveUserData(user, username, email);

                alert(`✅ تم تسجيل الدخول بنجاح كـ ${username}!`);
                window.location.href = "dashboard.html";

            } catch (error) {
                console.error("Social Sign-In Error:", error);
                // معالجة الأخطاء الخاصة بالتسجيل الاجتماعي
                if (error.code === 'auth/popup-closed-by-user') {
                    alert("❌ تم إغلاق نافذة الدخول.");
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    alert("❌ يوجد حساب بالفعل بهذا البريد الإلكتروني، ولكن تم التسجيل بطريقة مختلفة.");
                } else {
                    alert("❌ فشل تسجيل الدخول الاجتماعي: " + error.message);
                }
            }
        }

        // ربط الدوال بالأزرار
        document.getElementById('authButton').addEventListener('click', handleAuth);
        document.getElementById('googleLoginBtn').addEventListener('click', () => signInWithProvider(googleProvider));
        document.getElementById('facebookLoginBtn').addEventListener('click', () => signInWithProvider(facebookProvider));
    </script>
</body>
</html>
