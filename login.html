<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="LOGIN">تسجيل الدخول - Throne Void</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* إضافة تنسيقات بسيطة لصفحة الدخول */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: var(--secondary-dark);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        .auth-container h2 {
            color: var(--accent-yellow);
            margin-bottom: 25px;
        }
        .auth-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
        }
        .auth-container button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #authButton {
            background-color: var(--accent-blue);
            color: white;
            margin-bottom: 15px;
        }
        #authButton:hover {
            background-color: #2980b9;
        }
        #googleSignInBtn {
            background-color: #e74c3c;
            color: white;
            margin-bottom: 15px;
        }
        #googleSignInBtn:hover {
            background-color: #c0392b;
        }
        #toggleAuth, #forgotPasswordLink {
            background: none;
            color: var(--accent-yellow);
            text-decoration: underline;
            padding: 5px;
            width: auto;
            display: inline-block;
        }
        #forgotPasswordLink {
            display: block;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <button onclick="window.location='index.html'" style="background-color: #e74c3c;" data-i18n="HOME">الرئيسية</button>
        </div>
    </header>

    <main>
        <div class="auth-container">
            <h2 data-i18n="LOG_IN_ACCOUNT">تسجيل الدخول / إنشاء حساب</h2>
            <input type="email" id="emailInput" data-i18n="EMAIL_PLACEHOLDER" placeholder="البريد الإلكتروني" required>
            <input type="password" id="passwordInput" data-i18n="PASSWORD_PLACEHOLDER" placeholder="كلمة المرور" required>
            
            <a href="#" id="forgotPasswordLink" data-i18n="FORGOT_PASSWORD">نسيت كلمة المرور؟</a>

            <button id="authButton" data-i18n="AUTH_BUTTON_LOGIN">تسجيل الدخول</button>
            <button id="googleSignInBtn" data-i18n="SIGN_IN_WITH_GOOGLE">تسجيل الدخول باستخدام جوجل</button>
            <button id="toggleAuth" data-i18n="TOGGLE_TO_REGISTER">لا تملك حساباً؟ انقر للتسجيل</button>
        </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"; 

        // *** مفاتيح مشروعك الفعلي (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 
        const googleProvider = new GoogleAuthProvider();
        
        // -------------------------------------------------------------
        //                 دالة إنشاء ملف المستخدم في Firestore 
        // -------------------------------------------------------------
        async function createUserProfile(user) {
            const userDocRef = doc(db, "users", user.email);
            
            const defaultUsername = user.email.split('@')[0];

            await setDoc(userDocRef, {
                email: user.email,
                username: defaultUsername, 
                highScore: 0,
                energy: 100,
                lastEnergyUpdate: new Date(),
                avatarUrl: user.photoURL || "https://via.placeholder.com/100/1e1e1e/ffffff?text=U",
                isBanned: false,
                isMuted: false,
                language: localStorage.getItem('lang') || 'ar'
            }, { merge: true });
        }
        
        // -------------------------------------------------------------
        //                 دوال الواجهة
        // -------------------------------------------------------------
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authButton = document.getElementById('authButton');
        const toggleButton = document.getElementById('toggleAuth');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');

        let isLoginMode = true;

        function updateUI() {
            if (isLoginMode) {
                authButton.setAttribute('data-i18n', 'AUTH_BUTTON_LOGIN');
                toggleButton.setAttribute('data-i18n', 'TOGGLE_TO_REGISTER');
                forgotPasswordLink.style.display = 'block';
            } else {
                authButton.setAttribute('data-i18n', 'AUTH_BUTTON_REGISTER');
                toggleButton.setAttribute('data-i18n', 'TOGGLE_TO_LOGIN');
                forgotPasswordLink.style.display = 'none';
            }
            loadLanguage(); // إعادة تحميل اللغة لتحديث النصوص
        }

        toggleButton.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            updateUI();
        });
        
        // -------------------------------------------------------------
        //                 دالة تسجيل الدخول / التسجيل
        // -------------------------------------------------------------
        authButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                alert("الرجاء إدخال البريد الإلكتروني وكلمة المرور.");
                return;
            }

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await createUserProfile(userCredential.user);
                }
                window.location.href = "dashboard.html"; 
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                alert(`فشل المصادقة: ${error.message}`);
            }
        });

        // -------------------------------------------------------------
        //                 دالة تسجيل الدخول بجوجل
        // -------------------------------------------------------------
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                await createUserProfile(result.user);
                window.location.href = "dashboard.html";
            } catch (error) {
                console.error("Google Auth Error:", error);
                alert("فشل تسجيل الدخول باستخدام جوجل.");
            }
        });

        // -------------------------------------------------------------
        //                 دالة نسيت كلمة المرور
        // -------------------------------------------------------------
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            if (!email) {
                alert("الرجاء إدخال البريد الإلكتروني أولاً لإرسال رابط إعادة تعيين كلمة المرور.");
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                alert(`تم إرسال رابط إعادة تعيين كلمة المرور إلى ${email}.`);
            } catch (error) {
                console.error("Password Reset Error:", error);
                alert("فشل إرسال رابط إعادة التعيين. تأكد من صحة البريد الإلكتروني.");
            }
        });

        loadLanguage();
        updateUI(); 
    </script>
</body>
</html>
