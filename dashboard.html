<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Throne Void</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* التنسيقات الإضافية للداشبورد */
        .container { 
            background: #1f2a36; 
            padding: 40px; 
            border-radius: 12px; 
            max-width: 800px; 
            margin: 0 auto; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-yellow);
        }
        /* سنستخدم هذا الـ ID لتحميل اللعبة داخله */
        #game-container {
            width: 100%;
            height: 400px; /* يمكن تعديل الارتفاع حسب الرغبة */
            margin: 20px auto;
            background-color: #121212;
            border: 2px solid #3498db;
        }
        #highScoreDisplay { color: var(--accent-yellow); margin-bottom: 15px; } 
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>

</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <button onclick="window.location='settings.html'" style="background-color: #3498db;">SETTINGS</button>
            <button onclick="window.location='leaderboard.html'" style="background-color: var(--accent-yellow); color: var(--primary-dark);">LEADERBOARD</button>
            <button id="logoutBtn" style="background-color: var(--accent-red);">LOGOUT</button>
        </div>
    </header>

    <main>
        <div class="container">
            <h1>أهلاً بك أيها المحارب!</h1>
            <p>تم تسجيل دخولك باسم المستخدم: <span id="userEmailDisplay" style="color: #2ecc71;">جاري التحميل...</span></p>
            
            <p id="highScoreDisplay">أعلى نتيجة لديك: 0</p>
            
            <p style="margin-top: 10px;">استخدم الأسهم للحركة والمسافة (Space) لإطلاق النار. اللعبة تستخدم محرك Phaser الاحترافي.</p>

            <div id="game-container"></div>
            
        </div>
    </main>

    <script type="module">
        // استيراد مكتبات Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** مفاتيح مشروعك الفعلي (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = null;
        let currentHighScore = 0; 
        
        // --- دوال Firebase (كما هي) ---
        async function loadHighScore(email) {
            const userDocRef = doc(db, "users", email);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().highScore !== undefined) {
                    currentHighScore = docSnap.data().highScore;
                    document.getElementById('highScoreDisplay').innerText = `أعلى نتيجة لديك: ${currentHighScore}`;
                } else {
                    document.getElementById('highScoreDisplay').innerText = `أعلى نتيجة لديك: 0`;
                }
            } catch (error) {
                console.error("Error loading high score:", error);
            }
        }

        async function saveHighScore(newScore) {
            if (newScore > currentHighScore && currentUserEmail) {
                const userDocRef = doc(db, "users", currentUserEmail);
                try {
                    await setDoc(userDocRef, { highScore: newScore }, { merge: true });
                    currentHighScore = newScore;
                    document.getElementById('highScoreDisplay').innerText = `أعلى نتيجة لديك: ${currentHighScore} (تم تحديثها!)`;
                    console.log("High score saved successfully!");
                } catch (error) {
                    console.error("Error saving high score:", error);
                }
            }
        }
        
        // التحقق من حالة الدخول عند تحميل الصفحة
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                document.getElementById('userEmailDisplay').innerText = currentUserEmail;
                loadHighScore(currentUserEmail);
                // ** تشغيل لعبة Phaser فقط بعد التأكد من تسجيل الدخول **
                initPhaserGame(); 
            } else {
                alert("يجب عليك تسجيل الدخول أولاً للوصول إلى لوحة التحكم!");
                window.location.href = "login.html"; 
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        });

        // --- كود لعبة قتال فضائي احترافية باستخدام Phaser 3 ---
        
        function initPhaserGame() {
            // كود Phaser يتطلب تحميل مكتبته أولاً (في وسم <script> أعلى الصفحة)
            
            const config = {
                type: Phaser.AUTO,
                width: 600,
                height: 400,
                parent: 'game-container', // يجب أن يتطابق مع الـ ID في HTML
                physics: {
                    default: 'arcade',
                    arcade: {
                        debug: false
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };
            
            // إنشاء اللعبة
            const game = new Phaser.Game(config);

            let player;
            let stars; // نجوم أو أعداء
            let cursors;
            let score = 0;
            let scoreText;
            let gameOver = false;

            function preload ()
            {
                // لكي تعمل اللعبة بشكل صحيح، تحتاج إلى توفير صور للأصول (Assets)
                // هنا نستخدم لون كبديل للصورة لتشغيل الكود.
                this.load.image('starfield', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFXQAAAF0AQHwI3kAAAAOSURBVBhXY3R1/A8DCIAEAAIHAQfBvO9sAAAAAElFTkSuQmCC'); // خلفية سوداء كبديل
                this.load.image('ship', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5QgVDA0gE6I+eAAAAMZJREFUSEvtljEOgDAIxP+v2Jt2t0l637gDBp2M5r4fCgLg/wEQpL3d40E8A8F9wD5tI8KqL9j+sNdw8t7W5g6gA8gB1+b205oEa9BqgRpoA9bAPF7o0k/oD703E6lVvVd3YmK036yF093L3L85oT8Y9K79hHwgR2wF5dE9/kGk/iP8y40wAGm+q888wB696zO96v6g/jMTRF4gQvYg0e9A7w3x5y/jM0l8QIvYN/34d9X7g99AAAAAElFTkSuQmCC'); // صورة سفينة افتراضية (مربع أخضر)
                this.load.image('laser', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAACCAYAAAB7XA/XAAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5QgVDA0yD1n7zAAAADJJREFUCBNjYWBg2AYyJgYQkEAwMDIxMjMyBghA3AwM/k3YDAwMDYxM0gIMw9C1AwBN3QySgKkX5AAAAABJRU5ErkJggg=='); // ليزر افتراضي (خط أزرق)
            }

            function create ()
            {
                // إعداد خلفية اللعبة
                this.add.tileSprite(0, 0, config.width, config.height, 'starfield').setOrigin(0, 0);

                // اللاعب
                player = this.physics.add.image(config.width / 2, config.height - 50, 'ship').setDepth(1);
                player.setCollideWorldBounds(true);
                player.setDrag(100);
                player.setAngularDrag(100);
                player.setMaxVelocity(200);
                player.health = 100;
                
                // الأعداء (كمجموعة)
                stars = this.physics.add.group({
                    key: 'laser', // نستخدم الليزر كبديل مؤقت لظهور نقاط الأعداء
                    repeat: 11,
                    setXY: { x: 12, y: 0, stepX: 70 }
                });

                stars.children.iterate(function (child) {
                    child.setTint(0xffc700); // لون أصفر للأعداء
                    child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                    child.setCollideWorldBounds(true);
                    child.setVelocityY(Phaser.Math.Between(50, 100));
                });
                
                // مدخلات التحكم
                cursors = this.input.keyboard.createCursorKeys();
                this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);


                // عرض النتيجة
                scoreText = this.add.text(16, 16, 'SCORE: 0\nHEALTH: 100', { fontSize: '18px', fill: '#FFC700' }).setDepth(2);

                // إضافة تصادم بين اللاعب والأعداء (مؤقت)
                this.physics.add.collider(player, stars, hitStar, null, this);
            }

            function update ()
            {
                if (gameOver)
                {
                    return;
                }

                // تحريك اللاعب بالأسهم
                if (cursors.left.isDown)
                {
                    player.setAngularVelocity(-150);
                }
                else if (cursors.right.isDown)
                {
                    player.setAngularVelocity(150);
                }
                else
                {
                    player.setAngularVelocity(0);
                }

                if (cursors.up.isDown)
                {
                    this.physics.velocityFromRotation(player.rotation, 200, player.body.acceleration);
                }
                else
                {
                    player.setAcceleration(0);
                }
                
                // إطلاق النار بالمسافة (Space) - يمكنك تطوير هذه الدالة لتطلق ليزر
                if (Phaser.Input.Keyboard.JustDown(this.spaceKey)) {
                   // يتم تطوير نظام إطلاق النار في إصدارات Phaser الأكثر تعقيدًا
                   // هنا سنقوم فقط بزيادة النتيجة كبديل بسيط
                   score += 5;
                   scoreText.setText('SCORE: ' + score + '\nHEALTH: ' + player.health);
                }
            }

            function hitStar (player, star)
            {
                // دالة عند اصطدام اللاعب بالعدو
                star.disableBody(true, true);
                player.health -= 20;

                scoreText.setText('SCORE: ' + score + '\nHEALTH: ' + player.health);

                if (player.health <= 0)
                {
                    this.physics.pause();
                    player.setTint(0xff0000);
                    gameOver = true;
                    // حفظ أعلى نتيجة هنا
                    saveHighScore(score); 
                }
            }
        }
        
    </script>
</body>
</html>
