<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Throne Void</title>
    <style>
        body { 
            text-align: center; 
            padding: 50px; 
            font-family: 'Arial', sans-serif; 
            background: #121212; /* خلفية داكنة */
            color: #ecf0f1; /* نص فاتح */
        }
        .container { 
            background: #1f2a36; 
            padding: 40px; 
            border-radius: 12px; 
            max-width: 800px; 
            margin: 0 auto; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        h1 { color: #3498db; margin-bottom: 20px; }
        p { margin-bottom: 15px; }
        #userEmailDisplay { font-weight: bold; color: #2ecc71; display: block; margin-top: 10px; }
        
        button { 
            padding: 12px 25px; 
            background-color: #e74c3c; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin-top: 20px; 
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover { 
            background-color: #c0392b; 
        }
        /* تنسيق اللعبة المضاف */
        #gameArea {
            border: 2px solid #3498db;
            background-color: #121212; /* خلفية داكنة */
            margin: 20px auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>أهلاً بك في لوحة التحكم (Dashboard)!</h1>
        <p>تم تسجيل دخولك باسم المستخدم:</p>
        <span id="userEmailDisplay">جاري التحميل...</span>
        
        <p style="margin-top: 30px;">ابدأ لعبتك لتحدي البقاء الآن!</p>

        <canvas id="gameArea" width="600" height="400"></canvas>
        
        <button id="logoutBtn">تسجيل الخروج</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // *** مفاتيح مشروعك الفعلي (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // حماية الصفحة والتأكد من تسجيل الدخول
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // المستخدم مسجل دخوله، نعرض بريده ونبدأ اللعبة
                document.getElementById('userEmailDisplay').innerText = user.email;
                startGame(); // تبدأ اللعبة بعد تأكيد المستخدم
            } else {
                // المستخدم غير مسجل، يتم توجيهه إلى صفحة الدخول
                alert("يجب عليك تسجيل الدخول أولاً للوصول إلى لوحة التحكم!");
                window.location.href = "index.html"; 
            }
        });

        // دالة تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        });

        // -----------------------------------------------------------------
        // --- كود لعبة VOID FIGHTER القتالية ---
        // -----------------------------------------------------------------

        function startGame() {
            const canvas = document.getElementById('gameArea');
            const ctx = canvas.getContext('2d');

            // *** إضافة وسم الصوت إلى HTML إذا لم يكن موجوداً ***
            let music = document.getElementById('gameMusic');
            if (!music) {
                music = document.createElement('audio');
                music.id = 'gameMusic';
                // يجب وضع ملف survival_music.mp3 في نفس مجلد الملفات
                music.src = 'survival_music.mp3'; 
                music.loop = true;
                document.body.appendChild(music);
            }
            
            // إعدادات اللاعب
            let player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: 20,
                speed: 5,
                color: '#2ecc71',
                health: 100
            };

            let enemies = [];
            let bullets = []; // المقذوفات الجديدة
            let score = 0;
            let gameOver = true; // تبدأ اللعبة متوقفة
            let lastShotTime = 0;
            const shotCooldown = 300; // 300 مللي ثانية بين الطلقة والأخرى

            // تشغيل الموسيقى عند بدء اللعب
            function playMusic() {
                music.volume = 0.4;
                music.play().catch(error => {
                    console.log("Audio playback blocked.");
                });
            }
            
            // إعادة تعيين اللعبة
            function resetGame() {
                player.health = 100;
                enemies = [];
                bullets = [];
                score = 0;
                gameOver = false;
                update(); // بدء حلقة التحديث
                setInterval(spawnEnemy, 1500); // زيادة سرعة ظهور الأعداء
                playMusic();
            }

            // دالة إنشاء الأعداء
            function spawnEnemy() {
                if (gameOver) return;
                
                let edge = Math.floor(Math.random() * 4);
                let x, y;

                if (edge === 0) { x = Math.random() * canvas.width; y = -10; }
                else if (edge === 1) { x = Math.random() * canvas.width; y = canvas.height + 10; }
                else if (edge === 2) { x = -10; y = Math.random() * canvas.height; }
                else { x = canvas.width + 10; y = Math.random() * canvas.height; }

                enemies.push({
                    x: x,
                    y: y,
                    size: 15,
                    health: 30, // الأعداء يحتاجون لعدة طلقات
                    color: '#e74c3c', 
                    speed: 1.5 + Math.random() * 1.5 // سرعة أعداء معقولة
                });
            }

            // دالة إطلاق النار
            function fireBullet() {
                const currentTime = Date.now();
                if (currentTime - lastShotTime < shotCooldown || gameOver) {
                    return;
                }
                lastShotTime = currentTime;

                // إنشاء مقذوفة تنطلق للأعلى (يمكن تطويرها لاحقاً ليكون لها اتجاه محدد)
                bullets.push({
                    x: player.x,
                    y: player.y,
                    size: 5,
                    speed: 8,
                    damage: 10,
                    color: '#3498db', // لون المقذوفة (أزرق)
                });
            }

            // دالة الرسم
            function draw() {
                ctx.fillStyle = '#121212';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // رسم المقذوفات
                ctx.fillStyle = '#3498db';
                bullets.forEach(bullet => {
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
                    ctx.fill();
                });

                // رسم اللاعب
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x - player.size / 2, player.y - player.size / 2, player.size, player.size);

                // رسم الأعداء
                enemies.forEach(enemy => {
                    // رسم مستطيل العدو
                    ctx.fillStyle = enemy.color;
                    ctx.fillRect(enemy.x - enemy.size / 2, enemy.y - enemy.size / 2, enemy.size, enemy.size);
                    // رسم شريط الصحة فوق العدو
                    ctx.fillStyle = 'lime';
                    ctx.fillRect(enemy.x - enemy.size / 2, enemy.y - enemy.size / 2 - 5, enemy.size * (enemy.health / 30), 3);
                });

                // عرض النقاط والصحة
                ctx.fillStyle = 'white';
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Kills: ${score}`, 10, 25);
                ctx.fillText(`Health: ${player.health}`, 10, 45);

                // عرض رسالة البداية أو النهاية
                if (gameOver) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'white';
                    ctx.font = '40px Arial';
                    ctx.textAlign = 'center';
                    const message = score === 0 ? 'انقر للبدء' : 'انتهت اللعبة (GAME OVER)';
                    ctx.fillText(message, canvas.width / 2, canvas.height / 2);
                    if (score > 0) {
                         ctx.font = '20px Arial';
                         ctx.fillText(`النتيجة النهائية: ${score} عدو`, canvas.width / 2, canvas.height / 2 + 40);
                         ctx.fillText(`انقر في أي مكان لإعادة التشغيل`, canvas.width / 2, canvas.height / 2 + 70);
                    }
                }
            }

            // دالة التحديث والمنطق
            function update() {
                if (gameOver) return;

                // 1. تحديث حركة المقذوفات
                bullets.forEach((bullet, bIndex) => {
                    bullet.y -= bullet.speed;
                    // إزالة المقذوفات التي خرجت من الشاشة
                    if (bullet.y < 0) {
                        bullets.splice(bIndex, 1);
                    }
                });

                // 2. تحديث حركة الأعداء وكشف اصطدام الأعداء باللاعب
                enemies.forEach((enemy, eIndex) => {
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    // حركة العدو نحو اللاعب
                    enemy.x += (dx / distance) * enemy.speed;
                    enemy.y += (dy / distance) * enemy.speed;

                    // اصطدام العدو باللاعب
                    if (distance < (player.size / 2 + enemy.size / 2)) {
                        player.health -= 10; // فقدان صحة أكبر
                        enemies.splice(eIndex, 1); // حذف العدو بعد الاصطدام
                    }
                    
                    // 3. كشف اصطدام المقذوفات بالأعداء
                    bullets.forEach((bullet, bIndex) => {
                        const bx = bullet.x - enemy.x;
                        const by = bullet.y - enemy.y;
                        const bDistance = Math.sqrt(bx * bx + by * by);

                        if (bDistance < (bullet.size + enemy.size / 2)) {
                            enemy.health -= bullet.damage; // إنقاص صحة العدو
                            bullets.splice(bIndex, 1); // حذف المقذوفة

                            if (enemy.health <= 0) {
                                enemies.splice(eIndex, 1); // حذف العدو
                                score++; // زيادة النقاط
                            }
                        }
                    });
                });

                // 4. التحقق من نهاية اللعبة
                if (player.health <= 0) {
                    gameOver = true;
                    music.pause();
                    music.currentTime = 0; // إيقاف الموسيقى وإعادتها للبداية
                }

                draw();
                requestAnimationFrame(update);
            }
            
            // دالة تحريك اللاعب عبر الأسهم
            document.addEventListener('keydown', (e) => {
                if (gameOver) return;

                if (e.key === 'ArrowUp' || e.key === 'w') { player.y -= player.speed; }
                else if (e.key === 'ArrowDown' || e.key === 's') { player.y += player.speed; }
                else if (e.key === 'ArrowLeft' || e.key === 'a') { player.x -= player.speed; }
                else if (e.key === 'ArrowRight' || e.key === 'd') { player.x += player.speed; }
                else if (e.key === ' ') { fireBullet(); } // إطلاق النار عند الضغط على المسافة (Space)
                
                // تحديد حدود الحركة داخل اللوحة
                player.x = Math.max(player.size / 2, Math.min(canvas.width - player.size / 2, player.x));
                player.y = Math.max(player.size / 2, Math.min(canvas.height - player.size / 2, player.y));
            });

            // دالة البدء عند النقر
            canvas.addEventListener('click', () => {
                if (gameOver) {
                    resetGame();
                }
            });
            
            draw(); // نرسم الشاشة الأولية مع رسالة "انقر للبدء"
        }
    </script>
</body>
</html>
