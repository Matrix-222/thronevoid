<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <button onclick="window.location='chat.html'" style="background-color: #6c757d;">العودة للدردشة</button>
        <h1>لوحة تحكم المستخدم</h1>
        <button id="logoutBtn" class="logout-btn">تسجيل الخروج</button>
    </header>

    <main>
        <div class="dashboard-container">
            <h2>تحديث معلومات الحساب</h2>

            <div class="card profile-card">
                <h3>تغيير صورة الملف الشخصي (الأفاتار)</h3>
                
                <div id="currentAvatar" class="avatar-large male" style="margin: 20px auto;">
                    M
                </div>

                <input type="file" id="avatarFile" accept="image/*" style="margin-bottom: 15px;">
                <button id="uploadAvatarBtn" class="btn btn-primary">رفع وحفظ الصورة</button>
                <p id="avatarStatus" style="color: var(--text-light); margin-top: 10px;"></p>
            </div>
            
        </div>
    </main>

    <script src="api.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // *** مفاتيح مشروعك الفعلي (thronevoid) - تأكد من صحتها ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 

        let currentUser = null;
        const currentAvatar = document.getElementById('currentAvatar');
        const avatarFile = document.getElementById('avatarFile');
        const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
        const avatarStatus = document.getElementById('avatarStatus');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserInfo(currentUser.email);
            } else {
                window.location.href = "index.html";
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        uploadAvatarBtn.addEventListener('click', uploadNewAvatar);

        // ------------------------------------
        // جلب معلومات المستخدم الحالية وعرض الأفاتار
        // ------------------------------------
        async function loadUserInfo(email) {
            const userRef = doc(db, "users", email);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // عرض الأفاتار الحالي
                if (data.avatarUrl) {
                    currentAvatar.innerHTML = `<img src="${data.avatarUrl}" alt="Avatar">`;
                    currentAvatar.classList.remove('male', 'female');
                } else {
                    currentAvatar.textContent = (data.gender === 'male' || !data.gender) ? 'M' : 'F';
                    currentAvatar.className = `avatar-large ${data.gender || 'male'}`;
                    currentAvatar.innerHTML = currentAvatar.textContent; 
                }
            }
        }

        // ------------------------------------
        // منطق رفع الصورة وتحديثها (مُعدّل للتحقق من الأخطاء)
        // ------------------------------------
        async function uploadNewAvatar() {
            const file = avatarFile.files[0];
            if (!file) {
                avatarStatus.textContent = 'الرجاء اختيار صورة أولاً.';
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) { 
                 avatarStatus.textContent = 'حجم الملف كبير جداً (الحد الأقصى 2 ميجابايت).';
                 return;
            }

            try {
                uploadAvatarBtn.disabled = true;
                avatarStatus.textContent = '... يتم رفع الصورة، يرجى الانتظار ...';
                
                // 1. تحديد مسار التخزين
                const storageRef = ref(storage, `avatars/${currentUser.email}/profile_picture`);
                
                // 2. رفع الملف
                console.log("Starting upload...");
                const uploadTask = await uploadBytes(storageRef, file);
                console.log("Upload successful.", uploadTask);
                
                // 3. جلب رابط التنزيل العام
                const avatarUrl = await getDownloadURL(uploadTask.ref);
                console.log("Download URL obtained:", avatarUrl); 
                
                if (!avatarUrl) {
                     throw new Error("Failed to get download URL.");
                }

                // 4. تحديث مستند المستخدم في Firestore
                const userRef = doc(db, "users", currentUser.email);
                await updateDoc(userRef, {
                    avatarUrl: avatarUrl
                });
                console.log("Firestore updated successfully.");

                avatarStatus.textContent = 'تم تحديث الصورة بنجاح! ستظهر في الدردشات قريباً.';
                loadUserInfo(currentUser.email); // إعادة تحميل لعرض الصورة الجديدة

            } catch (error) {
                // عرض أي خطأ حدث هنا 
                console.error("Critical Error during avatar upload process:", error);
                avatarStatus.textContent = `فشل الرفع: ${error.message}`;
            } finally {
                uploadAvatarBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
