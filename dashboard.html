<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="PROFILE_DASHBOARD">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .form-container {
            max-width: 600px;
        }
        .profile-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .profile-header h2 {
            color: var(--accent-green);
        }
        #profile-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-blue);
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: bold;
        }
        .form-group small {
            display: block;
            color: var(--text-muted);
            margin-top: 5px;
            font-size: 0.8em;
        }
        .edit-button {
            width: 100%;
            margin-top: 20px;
            background-color: var(--accent-green);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-light);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div class="header-buttons">
            <button onclick="window.location='chat.html'" style="background-color: #4a4a4a;" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
                ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </button>
            <button onclick="window.location='dashboard.html'" data-i18n="PROFILE" style="background-color: var(--accent-blue);">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</button>
            <button onclick="logoutUser()" class="logout-btn" data-i18n="LOGOUT">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <main>
        <div class="form-container">
            <div class="profile-header">
                <img id="profile-image" src="https://i.pravatar.cc/150?u=default" alt="Profile Avatar">
                <h2 data-i18n="MY_PROFILE">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h2>
                <p id="user-email" style="color: var(--text-muted);"></p>
            </div>

            <div id="loading-spinner" class="loading-spinner"></div>
            
            <form id="profile-form">
                <div class="form-group">
                    <label for="username" data-i18n="USERNAME">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="username" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…">
                </div>

                <div class="form-group">
                    <label for="bio" data-i18n="BIO">Ø§Ù„Ù†Ø¨Ø°Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 150 Ø­Ø±Ù)</label>
                    <textarea id="bio" rows="4" maxlength="150" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ù†ÙØ³Ùƒ"></textarea>
                </div>

                <div class="form-group">
                    <label for="interests" data-i18n="INTERESTS">Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©)</label>
                    <input type="text" id="interests" placeholder="Ù…Ø«Ù„: Ù‚Ø±Ø§Ø¡Ø©, Ø³ÙØ±, Ø±ÙŠØ§Ø¶Ø©">
                    <small data-i18n="INTERESTS_HINT">ØªØ³Ø§Ø¹Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª ÙÙŠ Ù…Ø·Ø§Ø¨Ù‚ØªÙƒ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.</small>
                </div>

                <button type="submit" class="edit-button" data-i18n="SAVE_CHANGES">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <p id="status-message" style="text-align: center; margin-top: 15px; color: var(--accent-green);"></p>
            </form>
        </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (thronevoid) - ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§ ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const profileForm = document.getElementById('profile-form');
        const usernameInput = document.getElementById('username');
        const bioInput = document.getElementById('bio');
        const interestsInput = document.getElementById('interests');
        const userEmailElement = document.getElementById('user-email');
        const statusMessage = document.getElementById('status-message');
        const profileImage = document.getElementById('profile-image');
        const loadingSpinner = document.getElementById('loading-spinner');

        let currentUser = null;

        function showLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
            profileForm.style.display = show ? 'none' : 'block';
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userEmailElement.textContent = currentUser.email;
                profileImage.src = `https://i.pravatar.cc/150?u=${currentUser.email}`; // ØªØ¹ÙŠÙŠÙ† ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                fetchUserProfile(currentUser.email);
            } else {
                window.location.href = "index.html";
            }
        });

        async function fetchUserProfile(email) {
            showLoading(true);
            try {
                const userDoc = await getDoc(doc(db, "users", email));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    usernameInput.value = data.username || '';
                    bioInput.value = data.bio || '';
                    interestsInput.value = data.interests || '';
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
            }
            showLoading(false);
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            statusMessage.textContent = loadLanguage('SAVING');

            const profileData = {
                username: usernameInput.value.trim(),
                bio: bioInput.value.trim(),
                interests: interestsInput.value.trim(),
                lastUpdate: new Date().toISOString(),
                // ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø­Ù‚Ù„ isOnline ÙƒÙ…Ø§ Ù‡Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ Ø£Ùˆ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡
            };

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… setDoc Ù…Ø¹ Ø§Ù„Ø¯Ù…Ø¬ (merge: true) Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø«Ù„ isOnline
                await setDoc(doc(db, "users", currentUser.email), profileData, { merge: true });
                statusMessage.textContent = loadLanguage('SAVE_SUCCESS');
                // Ù…Ø³Ø­ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => statusMessage.textContent = '', 3000);
            } catch (error) {
                console.error("Error saving profile:", error);
                statusMessage.textContent = `${loadLanguage('SAVE_ERROR')} ${error.message}`;
            }
        });

        window.logoutUser = function() {
            signOut(auth).then(() => { 
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        }
    </script>
</body>
</html>
