<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="DASHBOARD_TITLE">Dashboard - Throne Void</title>
    <link rel="stylesheet" href="style.css"> 
    
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
        .container { 
            background: rgba(31, 42, 54, 0.9); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¨Ø´ÙØ§ÙÙŠØ© Ø®ÙÙŠÙØ© */
            padding: 40px; 
            border-radius: 12px; 
            max-width: 950px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ù„Ø¹Ø¨Ø© */
            margin: 40px auto; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--accent-yellow);
            position: relative;
            z-index: 10;
        }
        /* Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù€ ID Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¯Ø§Ø®Ù„Ù‡ */
        #game-container {
            width: 100%;
            height: 400px; 
            margin: 20px auto;
            background-color: #05050f; /* Ù„ÙˆÙ† ÙØ¶Ø§Ø¦ÙŠ Ø¯Ø§ÙƒÙ† */
            border: 2px solid var(--accent-red);
            /* Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Phaser ÙŠÙ…Ù„Ø£ Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± */
            overflow: hidden; 
        }
        #highScoreDisplay { 
            color: var(--accent-yellow); 
            margin-bottom: 15px; 
        } 
        /* ØªÙ†Ø³ÙŠÙ‚ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ø§Ù‚Ø© */
        .energy-display {
            color: #2ecc71; 
            margin-right: 20px;
            font-weight: bold;
            font-size: 1.1em;
            padding: 8px 15px;
            border: 1px solid #2ecc71;
            border-radius: 4px;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>

</head>
<body>
    
    <video autoplay muted loop id="background-video">
        <source src="background_void.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <span id="currentEnergy" class="energy-display">âš¡ 0 Energy</span> 
            
            <button onclick="window.location='store.html'" style="background-color: #2ecc71;" data-i18n="STORE">Ø§Ù„Ù…ØªØ¬Ø±</button>
            <button onclick="window.location='chat.html'" style="background-color: #E31B23;" data-i18n="ALLIANCES_CHAT">Ø´Ø§Øª Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª</button>
            
            <button onclick="window.location='settings.html'" style="background-color: #3498db;" data-i18n="SETTINGS">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button id="logoutBtn" style="background-color: var(--accent-red);" data-i18n="LOGOUT">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            
            <button id="langToggleBtn" style="background-color: #3498db;">ğŸŒ English</button>
        </div>
    </header>

    <main>
        <div class="container">
            <h1 data-i18n="WELCOME_WARLORD">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø­Ø§Ø±Ø¨!</h1>
            <p data-i18n="LOGGED_IN_AS">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</p>
            <span id="userEmailDisplay" style="color: #2ecc71; font-size: 1.1em; font-weight: bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            
            <p id="highScoreDisplay" data-i18n="HIGH_SCORE_DISPLAY">Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù„Ø¯ÙŠÙƒ: 0</p>
            
            <p style="margin-top: 10px;" data-i18n="GAME_INSTRUCTIONS">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ù‡Ù… Ù„Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ© (Space) Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø±. Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØ³ØªØ®Ø¯Ù… Ù…Ø­Ø±Ùƒ Phaser Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ.</p>

            <div id="game-container"></div>
            
        </div>
    </main>

    <script src="i18n.js"></script>
    
    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = null;
        let currentHighScore = 0; 
        const energyDisplay = document.getElementById('currentEnergy');
        
        // --- Ø¯ÙˆØ§Ù„ Firebase Ù„Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø·Ø§Ù‚Ø© ---
        async function loadUserData(email) {
            const userDocRef = doc(db, "users", email);
            try {
                const docSnap = await getDoc(userDocRef);
                let energy = 0;
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©
                    currentHighScore = data.highScore !== undefined ? data.highScore : 0;
                    document.getElementById('highScoreDisplay').innerText = `${translations['HIGH_SCORE_DISPLAY'][loadLanguage()]}: ${currentHighScore}`;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ù‚Ø©
                    energy = data.energy !== undefined ? data.energy : 0;
                }
                energyDisplay.textContent = `âš¡ ${energy} Energy`;
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function saveHighScore(newScore) {
            if (newScore > currentHighScore && currentUserEmail) {
                const userDocRef = doc(db, "users", currentUserEmail);
                try {
                    // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    await setDoc(userDocRef, { highScore: newScore }, { merge: true });
                    
                    // Ø®ØµÙ… 10 ÙˆØ­Ø¯Ø§Øª Ø·Ø§Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù…Ø«Ø§Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø§Ù‚Ø©)
                    await updateDoc(userDocRef, { energy: increment(-10) });
                    
                    currentHighScore = newScore;
                    document.getElementById('highScoreDisplay').innerText = `${translations['HIGH_SCORE_DISPLAY'][loadLanguage()]}: ${currentHighScore} (${translations['UPDATED_TEXT'][loadLanguage()]})`;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø·Ø§Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
                    loadUserData(currentUserEmail); 

                } catch (error) {
                    console.error("Error saving high score/deducting energy:", error);
                }
            }
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                document.getElementById('userEmailDisplay').innerText = currentUserEmail;
                loadUserData(currentUserEmail);
                // ** ØªØ´ØºÙŠÙ„ Ù„Ø¹Ø¨Ø© Phaser ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ **
                initPhaserGame(); 
            } else {
                alert("ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…!");
                window.location.href = "login.html"; 
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        });

        // -------------------------------------------------------------
        //               ğŸ”¥ ÙƒÙˆØ¯ Ø§Ù„Ù„ØºØ© (Ù…Ù† Ù…Ù„Ù i18n.js) ğŸ”¥
        // -------------------------------------------------------------
        
        let currentLang = loadLanguage();
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const langBtn = document.getElementById('langToggleBtn');
        function updateLangButton(lang) {
            langBtn.textContent = lang === 'ar' ? 'ğŸŒ English' : 'ğŸŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
        }
        updateLangButton(currentLang);
        
        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        langBtn.addEventListener('click', () => {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            setLanguage(currentLang);
            updateLangButton(currentLang);
            loadUserData(currentUserEmail); // ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ù†ØµÙˆØµ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ©
        });


        // -------------------------------------------------------------
        //             ğŸš€ ÙƒÙˆØ¯ Ù„Ø¹Ø¨Ø© Ù‚ØªØ§Ù„ ÙØ¶Ø§Ø¦ÙŠ (Phaser 3) ğŸš€
        // -------------------------------------------------------------
        
        function initPhaserGame() {
            
            const config = {
                type: Phaser.AUTO,
                width: 600,
                height: 400,
                parent: 'game-container', 
                physics: {
                    default: 'arcade',
                    arcade: {
                        debug: false
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
            const game = new Phaser.Game(config);

            let player;
            let stars; 
            let cursors;
            let score = 0;
            let scoreText;
            let gameOver = false;

            function preload ()
            {
                // *** Ù„ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠØŒ Ù‚Ù… Ø¨ØªÙˆÙÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ***
                this.load.image('starfield', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFXQAAAF0AQHwI3kAAAAOSURBVBhXY3R1/A8DCIAEAAIHAQfBvO9sAAAAAElFTkSuQmCC'); 
                this.load.image('ship', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5QgVDA0gE6I+eAAAAMZJREFUSEvtljEOgDAIxP+v2Jt2t0l637gDBp2M5r4fCgLg/wEQpL3d40E8A8F9wD5tI8KqL9j+sNdw8t7W5g6gA8gB1+b205oEa9BqgRpoA9bAPF7o0k/oD703E6lVvVd3YmK036yF093L3L85oT8Y9K79hHwgR2wF5dE9/kGk/iP8y40wAGm+q888wB696zO96v6g/jMTRF4gQvYg0e9A7w3x5y/jM0l8QIvYN/34d9X7g99AAAAAElFTkSuQmCC'); 
                this.load.image('laser', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAACCAYAAAB7XA/XAAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5QgVDA0yD1n7zAAAADJJREFUCBNjYWBg2AYyJgYQkEAwMDIxMjMyBghA3AwM/k3YDAwMDYxM0gIMw9C1AwBN3QySgKkX5AAAAABJRU5ErkJggg=='); 
            }

            function create ()
            {
                this.add.tileSprite(0, 0, config.width, config.height, 'starfield').setOrigin(0, 0);

                player = this.physics.add.image(config.width / 2, config.height - 50, 'ship').setDepth(1);
                player.setCollideWorldBounds(true);
                player.setDrag(100);
                player.setAngularDrag(100);
                player.setMaxVelocity(200);
                player.health = 100;
                
                stars = this.physics.add.group({
                    key: 'laser', 
                    repeat: 11,
                    setXY: { x: 12, y: 0, stepX: 70 }
                });

                stars.children.iterate(function (child) {
                    child.setTint(0xffc700); 
                    child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                    child.setCollideWorldBounds(true);
                    child.setVelocityY(Phaser.Math.Between(50, 100));
                });
                
                cursors = this.input.keyboard.createCursorKeys();
                this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);


                scoreText = this.add.text(16, 16, 'SCORE: 0\nHEALTH: 100', { fontSize: '18px', fill: '#FFC700' }).setDepth(2);

                this.physics.add.collider(player, stars, hitStar, null, this);
            }

            function update ()
            {
                if (gameOver)
                {
                    return;
                }

                if (cursors.left.isDown)
                {
                    player.setAngularVelocity(-150);
                }
                else if (cursors.right.isDown)
                {
                    player.setAngularVelocity(150);
                }
                else
                {
                    player.setAngularVelocity(0);
                }

                if (cursors.up.isDown)
                {
                    this.physics.velocityFromRotation(player.rotation, 200, player.body.acceleration);
                }
                else
                {
                    player.setAcceleration(0);
                }
                
                if (Phaser.Input.Keyboard.JustDown(this.spaceKey)) {
                   score += 5;
                   scoreText.setText('SCORE: ' + score + '\nHEALTH: ' + player.health);
                }
            }

            function hitStar (player, star)
            {
                star.disableBody(true, true);
                player.health -= 20;

                scoreText.setText('SCORE: ' + score + '\nHEALTH: ' + player.health);

                if (player.health <= 0)
                {
                    this.physics.pause();
                    player.setTint(0xff0000);
                    gameOver = true;
                    saveHighScore(score); 
                }
            }
        }
        
    </script>
</body>
</html>
