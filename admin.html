<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="ADMIN_DASHBOARD_TITLE">لوحة تحكم المدير</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background-color: var(--secondary-dark);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(189, 195, 199, 0.3);
        }
        .admin-header h2 {
            color: var(--accent-yellow);
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .admin-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 8px;
        }
        .admin-section h3 {
            color: var(--accent-blue);
            margin-bottom: 15px;
        }
        #userListTable {
            width: 100%;
            border-collapse: collapse;
            color: #ccc;
            font-size: 14px;
        }
        #userListTable th, #userListTable td {
            border: 1px solid #555;
            padding: 10px;
            text-align: right;
        }
        #userListTable th {
            background-color: #333;
            color: white;
        }
        #userListTable tr:hover {
            background-color: #3a3a3a;
        }
        .action-btn {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .promote-btn {
            background-color: #2ecc71; /* أخضر */
        }
        .demote-btn {
            background-color: #e74c3c; /* أحمر */
        }
        .promote-btn:hover { background-color: #27ae60; }
        .demote-btn:hover { background-color: #c0392b; }
        .is-admin {
            color: var(--accent-yellow);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <button onclick="window.location='dashboard.html'" style="background-color: #e67e22;" data-i18n="DASHBOARD">لوحة التحكم</button>
            <button onclick="logoutUser()" style="background-color: #e74c3c;" data-i18n="LOGOUT">تسجيل الخروج</button>
        </div>
    </header>

    <main>
        <div class="admin-container">
            <div class="admin-header">
                <h2 data-i18n="ADMIN_PANEL_WELCOME">أهلاً بك أيها المدير، تحكم في الإمبراطورية.</h2>
            </div>

            <div class="admin-section">
                <h3 data-i18n="USER_MANAGEMENT_TITLE">إدارة المستخدمين والصلاحيات</h3>
                
                <table id="userListTable">
                    <thead>
                        <tr>
                            <th data-i18n="USER_TABLE_USERNAME">اسم المستخدم</th>
                            <th data-i18n="USER_TABLE_EMAIL">البريد الإلكتروني</th>
                            <th data-i18n="USER_TABLE_ROLE">الصلاحية</th>
                            <th data-i18n="USER_TABLE_SCORE">النقاط</th>
                            <th data-i18n="USER_TABLE_ACTIONS">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        </tbody>
                </table>
                <p id="loadingMessage" style="color: #bdc3c7; margin-top: 15px;">يتم تحميل بيانات المستخدمين...</p>
            </div>

            </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            collection, 
            getDocs, 
            updateDoc, 
            query, 
            orderBy 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** مفاتيح مشروعك الفعلي (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // متغير لتخزين UID المستخدم الحالي
        let currentUserId = null;

        // -------------------------------------------------------------
        //             1. التحقق من صلاحيات المدير عند تحميل الصفحة
        // -------------------------------------------------------------

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // نستخدم الإيميل كمعرف للمستند، كما هو مُنفذ في login.html
                const userDocRef = doc(db, "users", user.email); 
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().isAdmin) {
                    // إذا كان المستخدم مديراً، ابدأ تحميل القائمة
                    document.getElementById('loadingMessage').textContent = "جارٍ تحميل قائمة المستخدمين...";
                    loadUserList();
                } else {
                    // إذا لم يكن مديراً، أعد التوجيه إلى لوحة التحكم
                    alert("ليس لديك صلاحيات الوصول إلى لوحة تحكم المدير.");
                    window.location.href = "dashboard.html";
                }
            } else {
                // إذا لم يكن مسجلاً دخوله، أعد التوجيه إلى صفحة الدخول
                window.location.href = "login.html";
            }
        });

        // -------------------------------------------------------------
        //             2. دالة تحميل وعرض قائمة المستخدمين
        // -------------------------------------------------------------

        async function loadUserList() {
            const usersCollectionRef = collection(db, "users");
            const q = query(usersCollectionRef, orderBy("score", "desc"));
            const usersSnapshot = await getDocs(q);
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = ''; // تفريغ القائمة قبل الإضافة
            document.getElementById('loadingMessage').style.display = 'none';

            usersSnapshot.forEach((docSnapshot) => {
                const userData = docSnapshot.data();
                const docId = docSnapshot.id; // الإيميل أو UID

                // بناء صف الجدول
                const row = usersTableBody.insertRow();
                
                // الخلية 1: اسم المستخدم
                row.insertCell().textContent = userData.username || 'N/A';
                
                // الخلية 2: الإيميل
                row.insertCell().textContent = userData.email || 'N/A';
                
                // الخلية 3: الصلاحية
                const roleCell = row.insertCell();
                roleCell.textContent = userData.isAdmin ? 'مدير' : 'مستخدم';
                if (userData.isAdmin) {
                    roleCell.classList.add('is-admin');
                }
                
                // الخلية 4: النقاط
                row.insertCell().textContent = userData.score !== undefined ? userData.score : 0;
                
                // الخلية 5: الإجراءات (الأزرار)
                const actionsCell = row.insertCell();

                // زر ترقية/تنزيل الصلاحية
                const roleBtn = document.createElement('button');
                roleBtn.textContent = userData.isAdmin ? 'تنزيل (Demote)' : 'ترقية (Promote)';
                roleBtn.className = `action-btn ${userData.isAdmin ? 'demote-btn' : 'promote-btn'}`;
                
                // لا تسمح للمدير بتغيير صلاحياته هو
                if (userData.uid === currentUserId) {
                    roleBtn.disabled = true;
                    roleBtn.textContent = 'أنت المدير';
                } else {
                    roleBtn.onclick = () => toggleAdminRole(docId, userData.isAdmin);
                }

                actionsCell.appendChild(roleBtn);

                // يمكن إضافة أزرار أخرى هنا (تغيير النقاط، حظر...) في المرحلة التالية
            });
        }

        // -------------------------------------------------------------
        //             3. دالة تبديل صلاحية المدير
        // -------------------------------------------------------------
        async function toggleAdminRole(docId, currentStatus) {
            if (!confirm(`هل أنت متأكد من تغيير حالة المدير للمستخدم ذو المعرّف: ${docId}؟`)) {
                return;
            }

            const userDocRef = doc(db, "users", docId);
            const newStatus = !currentStatus;

            try {
                await updateDoc(userDocRef, {
                    isAdmin: newStatus
                });
                alert(`✅ تم تحديث الصلاحية بنجاح! المستخدم أصبح الآن: ${newStatus ? 'مديراً' : 'مستخدماً'}.`);
                // إعادة تحميل القائمة لتحديث الواجهة
                loadUserList(); 
            } catch (error) {
                console.error("Error toggling admin role:", error);
                alert("❌ فشل تحديث الصلاحية. يرجى التحقق من قواعد Firestore.");
            }
        }
        
        // -------------------------------------------------------------
        //             4. دالة تسجيل الخروج (مُعرفة عالمياً)
        // -------------------------------------------------------------
        window.logoutUser = function() {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        }

    </script>
</body>
</html>
