<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="SETTINGS_PAGE_TITLE">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ù„Ø¹Ø¨Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: var(--secondary-dark);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.4);
            color: #ecf0f1;
        }
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #2c3e50;
        }
        .settings-section h2 {
            color: var(--accent-yellow);
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        .form-group label {
            flex-basis: 150px;
            font-weight: bold;
            color: #bdc3c7;
        }
        .form-group input[type="text"], 
        .form-group select {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: #fff;
        }
        .form-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #saveUsernameBtn {
            background-color: var(--accent-blue);
            color: white;
        }
        #saveUsernameBtn:hover {
            background-color: #2980b9;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
        .avatar-group {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        #currentAvatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--accent-yellow);
            object-fit: cover;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø± */
        .danger-zone {
            background-color: #34495e;
            border: 2px solid var(--accent-red);
        }
        .danger-zone h2 {
            color: var(--accent-red);
            border-bottom-color: var(--accent-red);
        }
        .danger-zone button {
            background-color: var(--accent-red);
            color: white;
            padding: 10px 30px;
        }
        .danger-zone button:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <button onclick="window.location='dashboard.html'" style="background-color: #2ecc71;" data-i18n="DASHBOARD">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button onclick="window.location='general_chat.html'" style="background-color: #3498db;" data-i18n="GENERAL_CHAT">Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…</button>
            <button onclick="window.location='alliances_chat.html'" style="background-color: #2ecc71;" data-i18n="ALLIANCES_CHAT">Ø´Ø§Øª Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª (Ø®Ø§Øµ)</button>
            <button id="logoutBtn" style="background-color: var(--accent-red);" data-i18n="LOGOUT">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <main>
        <div class="settings-container">
            <div class="settings-section">
                <h2 data-i18n="PROFILE_SETTINGS">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
                
                <div class="avatar-group">
                    <img id="currentAvatar" src="https://via.placeholder.com/100/1e1e1e/ffffff?text=U" alt="Profile Avatar">
                    <div>
                        <div class="form-group" style="margin-bottom: 5px;">
                            <label data-i18n="CHANGE_AVATAR">ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</label>
                            </div>
                        <p style="font-size: 0.8em; color: #7f8c8d;">(Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹)</p>
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="USERNAME">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                    <input type="text" id="usernameInput" data-i18n="CHANGE_USERNAME" placeholder="ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" minlength="3" maxlength="15">
                    <button id="saveUsernameBtn" data-i18n="SAVE_USERNAME">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
                </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="ACCOUNT_SETTINGS">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
                
                <div class="form-group">
                    <label data-i18n="CURRENT_EMAIL">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                    <span id="currentEmailDisplay" style="flex-grow: 1; color: white;">Loading...</span>
                    </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="LANGUAGE_SETTINGS">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©</h2>
                <div class="form-group">
                    <label data-i18n="SELECT_LANGUAGE">Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©:</label>
                    <select id="languageSelect">
                        <option value="ar" data-i18n="LANG_AR">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="en" data-i18n="LANG_EN">English</option>
                    </select>
                </div>
            </div>

            <div class="settings-section danger-zone">
                <h2 data-i18n="DANGER_ZONE">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h2>
                <div class="form-group">
                    <label data-i18n="DELETE_ACCOUNT">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</label>
                    <button data-i18n="DELETE">Ø­Ø°Ù</button>
                </div>
            </div>

        </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = null;

        // -------------------------------------------------------------
        //                 Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // -------------------------------------------------------------
        async function loadUserData(email) {
            currentUserEmail = email;
            document.getElementById('currentEmailDisplay').textContent = email;

            const userDocRef = doc(db, "users", email);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('usernameInput').value = userData.username || '';
                document.getElementById('currentAvatar').src = userData.avatarUrl || "https://via.placeholder.com/100/1e1e1e/ffffff?text=U";
            }
        }
        
        // -------------------------------------------------------------
        //             ğŸ”¥ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªØ¹Ø·ÙŠ ÙØ´Ù„) ğŸ”¥
        // -------------------------------------------------------------
        async function saveUsername() {
            if (!currentUserEmail) return;

            const newUsername = document.getElementById('usernameInput').value.trim();
            if (newUsername.length < 3 || newUsername.length > 15) {
                alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠÙ† 3 Ùˆ 15 Ø­Ø±ÙØ§Ù‹.");
                return;
            }

            try {
                const userDocRef = doc(db, "users", currentUserEmail);
                await updateDoc(userDocRef, {
                    username: newUsername
                });
                
                // ğŸ”¥ğŸ”¥ Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸ”¥ğŸ”¥
                alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù….");
                
            } catch (error) {
                console.error("Error updating username:", error);
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙØ´Ù„ Ø¹Ø§Ù…Ø© ÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Firebase
                alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….");
            }
        }

        // -------------------------------------------------------------
        //                 Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
        // -------------------------------------------------------------
        document.getElementById('languageSelect').addEventListener('change', (e) => {
            const newLang = e.target.value;
            setLanguage(newLang);
        });

        // -------------------------------------------------------------
        //                   Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
        // -------------------------------------------------------------
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadUserData(user.email);
            } else {
                window.location.href = "login.html";
            }
        });

        // Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
        document.getElementById('saveUsernameBtn').addEventListener('click', saveUsername);
        
        // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const currentLang = loadLanguage();
        document.getElementById('languageSelect').value = currentLang;
    </script>
</body>
</html>
