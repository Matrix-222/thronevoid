<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="SETTINGS">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - Throne Void</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        .settings-container {
            max-width: 800px;
            margin: 40px auto;
            background-color: var(--secondary-dark);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.2);
        }
        .setting-group {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #444;
        }
        .setting-group h3 {
            color: var(--accent-yellow);
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        .setting-item label {
            color: #ddd;
            font-size: 1.1em;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
        #profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-red);
            margin: 0 auto 20px;
            display: block;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© */
        .avatar-selection {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.2s;
        }
        .avatar-option:hover {
            border-color: var(--accent-yellow);
        }
        .avatar-option.selected {
            border-color: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª */
        #saveChangesBtn {
            width: 100%;
            margin-top: 30px;
            background-color: #2ecc71;
            padding: 15px;
            font-size: 1.2em;
        }
        .input-file-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <button onclick="window.location='dashboard.html'" style="background-color: #2ecc71;" data-i18n="DASHBOARD">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button id="langToggleBtn" style="background-color: #3498db;">ğŸŒ English</button>
        </div>
    </header>

    <main>
        <div class="settings-container">
            <h2 style="color: var(--accent-red); text-align: center;" data-i18n="SETTINGS_PAGE_TITLE">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ù„Ø¹Ø¨Ø©</h2>

            <div class="setting-group">
                <h3 data-i18n="PROFILE_SETTINGS">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
                
                <img id="profile-avatar" src="https://via.placeholder.com/100/1e1e1e/ffffff?text=U" alt="Profile Avatar">
                
                <label data-i18n="CHOOSE_AVATAR" style="display: block; text-align: center; margin-bottom: 10px;">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©:</label>
                
                <div class="avatar-selection">
                    <img class="avatar-option" src="https://i.imgur.com/gK2T3i8.png" data-url="https://i.imgur.com/gK2T3i8.png" alt="Avatar 1">
                    <img class="avatar-option" src="https://i.imgur.com/vHqQ3gS.png" data-url="https://i.imgur.com/vHqQ3gS.png" alt="Avatar 2">
                    <img class="avatar-option" src="https://i.imgur.com/7A2f3U3.png" data-url="https://i.imgur.com/7A2f3U3.png" alt="Avatar 3">
                </div>

                <div class="input-file-container">
                    <label for="imageUpload" data-i18n="UPLOAD_IMAGE">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label>
                    <input type="file" id="imageUpload" accept="image/*" style="margin-right: 15px;">
                </div>
            </div>

            <div class="setting-group">
                <h3 data-i18n="LANGUAGE_SETTINGS">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©</h3>
                <div class="setting-item">
                    <label for="langSelect" data-i18n="SELECT_LANGUAGE">Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©:</label>
                    <select id="langSelect">
                        <option value="ar" data-i18n="LANG_AR">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="en" data-i18n="LANG_EN">English</option>
                    </select>
                </div>
            </div>

            <div class="setting-group">
                <h3 data-i18n="ACCOUNT_SETTINGS">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                <div class="setting-item">
                    <label data-i18n="CHANGE_PASSWORD">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <button id="changePassBtn" style="background-color: #3498db;" data-i18n="EDIT">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
                <div class="setting-item">
                    <label data-i18n="CURRENT_EMAIL">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                    <span id="currentEmail" style="color: var(--accent-yellow);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
            </div>
            
            <button id="saveChangesBtn" data-i18n="SAVE_CHANGES">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            
        </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"; // ØªÙ… Ø¥Ø¶Ø§ÙØ© sendPasswordResetEmail
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // *** Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app", 
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 

        let currentUser = null;
        let selectedAvatarUrl = null;
        
        const profileAvatar = document.getElementById('profile-avatar');
        const langSelect = document.getElementById('langSelect');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const defaultAvatar = "https://via.placeholder.com/100/1e1e1e/ffffff?text=U"; 

        // -------------------------------------------------------------
        //                 Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // -------------------------------------------------------------
        
        async function loadUserSettings(email) {
            const userDocRef = doc(db, "users", email);
            const docSnap = await getDoc(userDocRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                const avatarUrl = data.avatarUrl || defaultAvatar;
                profileAvatar.src = avatarUrl;
                selectedAvatarUrl = avatarUrl;
                
                document.querySelectorAll('.avatar-option').forEach(img => {
                    img.classList.remove('selected');
                    if (img.getAttribute('data-url') === avatarUrl) {
                        img.classList.add('selected');
                    }
                });
                
                const savedLang = data.language || loadLanguage();
                langSelect.value = savedLang;
                setLanguage(savedLang); 
                updateLangButton(savedLang);
            }
        }
        
        async function saveSettings() {
            if (!currentUser) return;
            saveChangesBtn.disabled = true; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸
            saveChangesBtn.textContent = '...Saving';
            
            const userDocRef = doc(db, "users", currentUser.email);
            const newLang = langSelect.value;

            try {
                await setDoc(userDocRef, {
                    avatarUrl: selectedAvatarUrl,
                    language: newLang
                }, { merge: true });

                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                setLanguage(newLang); 
            } catch (error) {
                console.error("Error saving settings:", error);
                alert("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!");
            } finally {
                saveChangesBtn.disabled = false; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                setLanguage(currentLang); // Ù„ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ "Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª" Ø£Ùˆ "Save Changes"
            }
        }
        
        // -------------------------------------------------------------
        //             ğŸ”¥ Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ğŸ”¥
        // -------------------------------------------------------------
        
        async function updatePasswordClicked() {
            if (!currentUser || currentUser.providerId === 'google.com') {
                 alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¬ÙˆØ¬Ù„ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„Ø©.");
                 return;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            try {
                await sendPasswordResetEmail(auth, currentUser.email);
                alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (${currentUser.email}). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ø§Ù„Ù‡Ø§Ù… (Spam).`);
            } catch (error) {
                console.error("Password Reset Error:", error);
                alert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØºÙŠÙŠØ±. ÙŠØ±Ø¬Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£ÙˆÙ„Ø§Ù‹.");
            }
        }
        
        // -------------------------------------------------------------
        //                    Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
        // -------------------------------------------------------------
        
        document.getElementById('imageUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;
            
            saveChangesBtn.disabled = true;
            saveChangesBtn.textContent = '...Uploading';
            
            try {
                const storageRef = ref(storage, `avatars/${currentUser.uid}/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                
                profileAvatar.src = url;
                selectedAvatarUrl = url;
                
                document.getElementById('imageUpload').value = ''; 
                document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));

                alert("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! Ù„Ø§ ØªÙ†Ø³ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'.");

            } catch (error) {
                console.error("Image Upload Error:", error);
                alert("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Firebase Storage ÙˆØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯.");
            } finally {
                saveChangesBtn.disabled = false;
                setLanguage(currentLang);
            }
        });
        
        // -------------------------------------------------------------
        //                       Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„ØªØ­ÙƒÙ…
        // -------------------------------------------------------------

        document.querySelectorAll('.avatar-option').forEach(img => {
            img.addEventListener('click', function() {
                document.querySelectorAll('.avatar-option').forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');
                
                const url = this.getAttribute('data-url');
                profileAvatar.src = url;
                selectedAvatarUrl = url;
                
                document.getElementById('imageUpload').value = '';
            });
        });

        document.getElementById('changePassBtn').addEventListener('click', updatePasswordClicked); // Ø±Ø¨Ø· Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        document.getElementById('saveChangesBtn').addEventListener('click', saveSettings);
        
        let currentLang = loadLanguage();
        const langToggleBtn = document.getElementById('langToggleBtn'); 
        
        function updateLangButton(lang) {
            langToggleBtn.textContent = lang === 'ar' ? 'ğŸŒ English' : 'ğŸŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
        }

        langToggleBtn.addEventListener('click', () => {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            setLanguage(currentLang);
            updateLangButton(currentLang);
            langSelect.value = currentLang; 
        });
        
        langSelect.addEventListener('change', (e) => {
            currentLang = e.target.value;
            setLanguage(currentLang);
            updateLangButton(currentLang);
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('currentEmail').innerText = user.email;
                loadUserSettings(user.email);
            } else {
                window.location.href = "login.html"; 
            }
        });
    </script>
</body>
</html>
