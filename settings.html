<body>
    <main>
        <div class="settings-container">
            </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = null;

        // -------------------------------------------------------------
        //                 Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // -------------------------------------------------------------
        async function loadUserData(email) {
            currentUserEmail = email;
            document.getElementById('currentEmailDisplay').textContent = email;

            const userDocRef = doc(db, "users", email);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('usernameInput').value = userData.username || '';
                document.getElementById('currentAvatar').src = userData.avatarUrl || "https://via.placeholder.com/100/1e1e1e/ffffff?text=U";
            }
        }
        
        // -------------------------------------------------------------
        //             ğŸ”¥ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ğŸ”¥
        // -------------------------------------------------------------
        async function saveUsername() {
            if (!currentUserEmail) return;

            const newUsername = document.getElementById('usernameInput').value.trim();
            if (newUsername.length < 3 || newUsername.length > 15) {
                alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠÙ† 3 Ùˆ 15 Ø­Ø±ÙØ§Ù‹.");
                return;
            }

            try {
                const userDocRef = doc(db, "users", currentUserEmail);
                await updateDoc(userDocRef, {
                    username: newUsername
                });
                
                // ğŸ”¥ğŸ”¥ ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø±Ø³Ø§Ù„Ø© ÙØ´Ù„ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª ğŸ”¥ğŸ”¥
                alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                
            } catch (error) {
                console.error("Error updating username:", error);
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙØ´Ù„ Ø¹Ø§Ù…Ø© ÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Firebase
                alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….");
            }
        }


        // -------------------------------------------------------------
        //                   Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ù… ÙŠØªØºÙŠØ±)
        // -------------------------------------------------------------
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadUserData(user.email);
            } else {
                window.location.href = "login.html";
            }
        });

        // Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
        document.getElementById('saveUsernameBtn').addEventListener('click', saveUsername);
        
        // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ©
        loadLanguage();
    </script>
</body>
</html>
