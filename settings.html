<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="SETTINGS_PAGE_TITLE">إعدادات الحساب واللعبة</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: var(--secondary-dark);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.4);
            color: #ecf0f1;
        }
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #2c3e50;
        }
        .settings-section h2 {
            color: var(--accent-yellow);
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        .form-group label {
            flex-basis: 150px;
            font-weight: bold;
            color: #bdc3c7;
        }
        .form-group input[type="text"], 
        .form-group select {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: #fff;
        }
        .form-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #saveUsernameBtn {
            background-color: var(--accent-blue);
            color: white;
        }
        #saveUsernameBtn:hover {
            background-color: #2980b9;
        }

        /* تنسيقات الصورة الشخصية */
        .avatar-group {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        #currentAvatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--accent-yellow);
            object-fit: cover;
        }

        /* منطقة الخطر */
        .danger-zone {
            background-color: #34495e;
            border: 2px solid var(--accent-red);
        }
        .danger-zone h2 {
            color: var(--accent-red);
            border-bottom-color: var(--accent-red);
        }
        .danger-zone button {
            background-color: var(--accent-red);
            color: white;
            padding: 10px 30px;
        }
        .danger-zone button:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <header>
        <h1>THRONES OF THE VOID</h1>
        <div>
            <button onclick="window.location='dashboard.html'" style="background-color: #2ecc71;" data-i18n="DASHBOARD">لوحة التحكم</button>
            <button onclick="window.location='general_chat.html'" style="background-color: #3498db;" data-i18n="GENERAL_CHAT">الشات العام</button>
            <button onclick="window.location='alliances_chat.html'" style="background-color: #2ecc71;" data-i18n="ALLIANCES_CHAT">شات التحالفات (خاص)</button>
            <button id="logoutBtn" style="background-color: var(--accent-red);" data-i18n="LOGOUT">تسجيل الخروج</button>
        </div>
    </header>

    <main>
        <div class="settings-container">
            <div class="settings-section">
                <h2 data-i18n="PROFILE_SETTINGS">إعدادات الملف الشخصي</h2>
                
                <div class="avatar-group">
                    <img id="currentAvatar" src="https://via.placeholder.com/100/1e1e1e/ffffff?text=U" alt="Profile Avatar">
                    <div>
                        <div class="form-group" style="margin-bottom: 5px;">
                            <label data-i18n="CHANGE_AVATAR">تغيير صورة البروفايل</label>
                            </div>
                        <p style="font-size: 0.8em; color: #7f8c8d;">(هذه الميزة غير مفعلة حالياً)</p>
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="USERNAME">اسم المستخدم:</label>
                    <input type="text" id="usernameInput" data-i18n="CHANGE_USERNAME" placeholder="تغيير اسم المستخدم" minlength="3" maxlength="15">
                    <button id="saveUsernameBtn" data-i18n="SAVE_USERNAME">حفظ الاسم</button>
                </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="ACCOUNT_SETTINGS">إعدادات الحساب</h2>
                
                <div class="form-group">
                    <label data-i18n="CURRENT_EMAIL">البريد الإلكتروني الحالي:</label>
                    <span id="currentEmailDisplay" style="flex-grow: 1; color: white;">Loading...</span>
                    </div>
            </div>

            <div class="settings-section">
                <h2 data-i18n="LANGUAGE_SETTINGS">إعدادات اللغة</h2>
                <div class="form-group">
                    <label data-i18n="SELECT_LANGUAGE">اختر اللغة:</label>
                    <select id="languageSelect">
                        <option value="ar" data-i18n="LANG_AR">العربية</option>
                        <option value="en" data-i18n="LANG_EN">English</option>
                    </select>
                </div>
            </div>

            <div class="settings-section danger-zone">
                <h2 data-i18n="DANGER_ZONE">منطقة الخطر</h2>
                <div class="form-group">
                    <label data-i18n="DELETE_ACCOUNT">حذف الحساب نهائياً</label>
                    <button data-i18n="DELETE">حذف</button>
                </div>
            </div>

        </div>
    </main>

    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** مفاتيح مشروعك الفعلي (thronevoid) ***
        const firebaseConfig = {
            apiKey: "AIzaSyB-bfHRJW3E8KW3-o-PkNW6xi5ytrTKMJE", 
            authDomain: "thronevoid.firebaseapp.com",
            projectId: "thronevoid",
            storageBucket: "thronevoid.firebasestorage.app",
            messagingSenderId: "958587822012",
            appId: "1:958587822012:web:312cf3d9e7c87e1c6415b9",
            measurementId: "G-N34T3VRGX0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = null;

        // -------------------------------------------------------------
        //                 دالة تحميل بيانات المستخدم
        // -------------------------------------------------------------
        async function loadUserData(email) {
            currentUserEmail = email;
            document.getElementById('currentEmailDisplay').textContent = email;

            const userDocRef = doc(db, "users", email);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('usernameInput').value = userData.username || '';
                document.getElementById('currentAvatar').src = userData.avatarUrl || "https://via.placeholder.com/100/1e1e1e/ffffff?text=U";
            }
        }
        
        // -------------------------------------------------------------
        //             ✅ دالة حفظ اسم المستخدم الجديد (مُصحَّحة) ✅
        // -------------------------------------------------------------
        async function saveUsername() {
            if (!currentUserEmail) return;

            // هنا يتم قراءة القيمة من حقل الإدخال HTML، وليس كمتغير جافاسكريبت
            const newUsername = document.getElementById('usernameInput').value.trim(); 
            if (newUsername.length < 3 || newUsername.length > 15) {
                alert("يجب أن يكون اسم المستخدم بين 3 و 15 حرفاً.");
                return;
            }

            try {
                const userDocRef = doc(db, "users", currentUserEmail);
                await updateDoc(userDocRef, {
                    username: newUsername
                });
                
                alert("✅ تم تحديث اسم المستخدم بنجاح!");
                
            } catch (error) {
                console.error("Firebase Security Error:", error);
                
                if (error.code === 'permission-denied') {
                    alert("❌ فشل تحديث الاسم: خطأ أمان في Firebase. تأكد أن القاعدة تسمح للمالك فقط بالتعديل.");
                } else {
                    alert(`❌ فشل تحديث الاسم. يرجى التحقق من اتصالك بالإنترنت. (${error.code})`);
                }
            }
        }

        // -------------------------------------------------------------
        //                 دالة تغيير اللغة
        // -------------------------------------------------------------
        document.getElementById('languageSelect').addEventListener('change', (e) => {
            const newLang = e.target.value;
            setLanguage(newLang);
        });

        // -------------------------------------------------------------
        //                   التحقق من الدخول
        // -------------------------------------------------------------
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadUserData(user.email);
            } else {
                window.location.href = "login.html";
            }
        });

        // ربط الزر بالدالة
        document.getElementById('saveUsernameBtn').addEventListener('click', saveUsername);
        
        // زر تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        // تطبيق اللغة وتعيين القيمة الافتراضية في القائمة
        const currentLang = loadLanguage();
        document.getElementById('languageSelect').value = currentLang;
    </script>
</body>
</html>
